<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    Admin Panel
  </title>
  <link rel="shortcut icon" href="/images/logo-mb.png" type="image/png">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.3.0/mdb.min.css" rel="stylesheet" />
  <script src="/ckeditor/ckeditor.js"></script>
  <link rel="stylesheet" href="/styles/grid.css">
  <link rel="stylesheet" href="/styles/dashboard.css">
  <link rel="stylesheet" href="/styles/custom_user.css">
  <link rel="stylesheet" href="/styles/alert.css">
</head>

<body>
  <style>
    #loading_spinner {
      position: absolute;
      top: 50%;
      left: 45%;
      height: 100%;
      translate: (-50%, -50%);
      z-index: 999;
    }
  </style>
   <div id="loading_spinner" style="display:none;">
    <img src="/images/spinner.gif" alt="Loading...">
  </div>
  <div class="main-content py-2 container-fluid py-4">
    <div class="my-2 text-light">
      <a class="text-light btn btn-primary" href="/combined-question/view-subject?class_id=<%= filter.class_id %>&subject=<%= filter.subject %>&q_set=<%= filter.q_set %>&q_type=<%= filter.q_type %>">Subject List</a>
      <a class="text-light btn btn-success" href="/combined-question/view-set?q_set_id=<%= filter.q_set  %>">View Question Preview</a>
      <button class="btn ">Selected : <span id="total_select"> <%= total_selected ? total_selected : '0'  %> </span> / <%= q_set_ids[0].total_qus ? q_set_ids[0].total_qus : '0'  %></button>
    </div>
    <% if(questions.length == 0){ %>
    <p>no question</p>
    <% }else{ %>
    <div class="table-responsive table-nowrap ">
      <table class="table table-bordered">
        <thead class="table-dark ">
          <tr>
            <th scope="col">SL</th>
            <th scope="col">Action</th>
            <th scope="col">Question</th>
            <th scope="col">Opt1</th>
            <th scope="col">Opt2</th>
            <th scope="col">Opt3</th>
            <th scope="col">Opt4</th>
          </tr>
        </thead>
        <tbody>
          <% let object = {} %>
          <% let str = q_set_ids[0].questions %>
          <% if(str !== null){ %>
            <% let numString = '' %>
            <% for (let i=0;i<str.length;i++){ %>
              <% if(str[i] !== ',' && str[i] !== ' '){ %>
                <% numString += str[i] %>
                <% continue %>
              <% }%>
              <% if(numString !== ''){ %>
                <% object[numString] = true %>
                <% numString = '' %>
              <% } %>
            <% } %>
            <% if(numString !== ''){ %>
              <% object[numString] = true %>
              <% numString = '' %>
            <% } %>
          <% } %>
          <% for(let i=0; i<questions.length; i++){ %>
          <% let opt = JSON.parse(questions[i].question_option) %>
          <input type="text" class="q_id" value="<%= questions[i].id %>" hidden>
          <input type="text" class="q_ans" value="<%= questions[i].question_answer %>" hidden>
          <tr>
            <td><%= i+1  %></td>
            <% if(object[questions[i].id]){ %>
              <td><button class="btn btn-sm btn-success add_btn" disabled>Added</button></td>
            <% }else{ %>
              <td><button class="btn btn-sm btn-primary add_btn">Add</button></td>
            <% }%>
            <td><%- questions[i].question_text %></td>
            <td><%- opt[0] %></td>
            <td><%- opt[1] %></td>
            <td><%- opt[2] %></td>
            <td><%- opt[3] %></td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>
   
    <div class="d-flex justify-content-center py-5">
      <nav aria-label="...">
          <ul class="pagination">
            <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>"  >
              <a  href="/combined-question/view-questions?class_id=<%= questions[0].class_id %>&subject_id=<%= questions[0].subject_id %>&chapter=<%= questions[0].chapter_id %>&q_set=<%= filter.q_set %>&page=<%=currentPage-1 %>&q_type=<%= q_type %>" class="page-link" >Previous</a>
            </li>
            <% for(let i=0; i< totalPage; i++) {%> 
              <li class="page-item  <%= currentPage == i+1 ? "active" : "" %> "><a class="page-link" href="/combined-question/view-questions?class_id=<%= questions[0].class_id %>&subject_id=<%= questions[0].subject_id %>&chapter=<%= questions[0].chapter_id %>&q_set=<%= filter.q_set %>&page=<%=i+1 %>&q_type=<%= q_type %>"><%= i+1 %> </a></li>
            <% }%> 
            <li class="page-item <%= currentPage >= totalPage ? 'disabled' : '' %>"  >
              <a class="page-link" href="/combined-question/view-questions?class_id=<%= questions[0].class_id %>&subject_id=<%= questions[0].subject_id %>&chapter=<%= questions[0].chapter_id %>&q_set=<%= filter.q_set %>&page=<%=currentPage+1 %>&q_type=<%= q_type %>">Next</a>
            </li>
          </ul>
        </nav>
    </div>
    <% } %>
    <%- include('../partials/footer.ejs') %>
    <script>
      let loading_spinner = document.getElementById('loading_spinner')
      let add_btn = document.getElementsByClassName('add_btn')
      let q_id = document.getElementsByClassName('q_id')
      let q_ans = document.getElementsByClassName('q_ans')
      for (let i = 0; i < add_btn.length; i++) {
        add_btn[i].addEventListener('click', () => {
          loading_spinner.style.display='block'
          fetch(`/combined-question/add-question?q_id=${q_id[i].value}&a_id=${q_ans[i].value}&q_set=<%=filter.q_set%>`)
            .then(res => res.json())
            .then(data => {
              console.log(q_id[i].value);
              loading_spinner.style.display='none'
              if (data.status === 200) {
                let total_select = document.getElementById('total_select')
                total_select.innerText = Number(total_select.innerText) + 1
                add_btn[i].innerText = 'added'
                add_btn[i].disabled = true
                add_btn[i].classList.add('btn-success')
              } else if (data.status === 400) {
                add_btn[i].innerText = 'already added'
                add_btn[i].classList.add('btn-danger')
              }
            })
        })
      }
    </script>
     <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
     <script>
         CKEDITOR.replace('content', {
             height: 700,
             removeButtons: 'PasteFromWord',      
         });
         if (CKEDITOR.env.ie && CKEDITOR.env.version == 8) {
             document.getElementById('ie8-warning').className = 'tip alert';
         }
     </script>
</body>
</html>